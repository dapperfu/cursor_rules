#!/usr/bin/env bash

# cursor-rules installation script
# This script adds or updates the cursor_rules repository as a git submodule
# in the .cursor/rules directory of the current project.
#
# Usage:
#   cursor-rules                    # Run in current directory
#   cursor-rules /path/to/project   # Run in specified directory
#   cursor-rules update             # Update the script itself from the repo

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Repository URL
REPO_URL="https://github.com/dapperfu/cursor_rules.git"
SCRIPT_URL="https://raw.githubusercontent.com/dapperfu/cursor_rules/main/cursor-rules"
SUBMODULE_PATH=".cursor/rules"

# Function to update the script itself
update_script() {
    local script_path
    script_path="$(readlink -f "$0" 2>/dev/null || realpath "$0" 2>/dev/null || echo "$0")"
    
    if [ ! -w "$script_path" ]; then
        echo -e "${RED}Error: Cannot write to $script_path${NC}" >&2
        echo "You may need to run with appropriate permissions." >&2
        exit 1
    fi
    
    echo -e "${YELLOW}Updating cursor-rules script...${NC}"
    
    # Create a temporary file
    local temp_file
    temp_file="$(mktemp)"
    
    # Download the latest version
    if curl -fsSL "$SCRIPT_URL" -o "$temp_file"; then
        # Verify it's a valid script (starts with shebang)
        if [ "$(head -c 2 "$temp_file")" = "#!" ]; then
            # Replace the script
            mv "$temp_file" "$script_path"
            chmod +x "$script_path"
            echo -e "${GREEN}Successfully updated cursor-rules script.${NC}"
        else
            rm -f "$temp_file"
            echo -e "${RED}Error: Downloaded file is not a valid script.${NC}" >&2
            exit 1
        fi
    else
        rm -f "$temp_file"
        echo -e "${RED}Error: Failed to download updated script.${NC}" >&2
        exit 1
    fi
}

# Function to install/update the submodule
install_submodule() {
    local target_dir="$1"
    
    # Change to target directory
    if [ ! -d "$target_dir" ]; then
        echo -e "${RED}Error: Directory does not exist: $target_dir${NC}" >&2
        exit 1
    fi
    
    cd "$target_dir"
    
    # Check if we're in a git repository
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo -e "${RED}Error: Not in a git repository: $target_dir${NC}" >&2
        echo "Please run this script from the root of a git repository." >&2
        exit 1
    fi
    
    # Create .cursor directory if it doesn't exist
    mkdir -p .cursor
    
    # Check if .cursor/rules is already a submodule
    if git submodule status "$SUBMODULE_PATH" > /dev/null 2>&1; then
        echo -e "${YELLOW}Submodule $SUBMODULE_PATH already exists. Updating to latest version...${NC}"
        
        # Update the submodule to the latest version
        git submodule update --init --remote "$SUBMODULE_PATH"
        
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}Successfully updated $SUBMODULE_PATH to the latest version.${NC}"
            echo ""
            echo "To commit this update, run:"
            echo "  git add $SUBMODULE_PATH"
            echo "  git commit -m 'Update cursor rules submodule'"
        else
            echo -e "${RED}Error: Failed to update submodule.${NC}" >&2
            exit 1
        fi
    else
        # Check if .cursor/rules exists but is not a submodule
        if [ -d "$SUBMODULE_PATH" ] || [ -f "$SUBMODULE_PATH" ]; then
            echo -e "${RED}Error: $SUBMODULE_PATH already exists but is not a git submodule.${NC}" >&2
            echo "Please remove it first or use a different path." >&2
            exit 1
        fi
        
        echo -e "${GREEN}Adding cursor_rules as a submodule to $SUBMODULE_PATH...${NC}"
        
        # Add the repository as a submodule
        if git submodule add "$REPO_URL" "$SUBMODULE_PATH"; then
            echo -e "${GREEN}Successfully added cursor_rules as a submodule.${NC}"
            
            # Initialize and update all submodules recursively
            git submodule update --init --recursive
            
            echo ""
            echo -e "${GREEN}Installation complete!${NC}"
            echo ""
            echo "The cursor rules are now available at $SUBMODULE_PATH"
            echo "Cursor will automatically load all .mdc files from this directory."
        else
            echo -e "${RED}Error: Failed to add submodule.${NC}" >&2
            exit 1
        fi
    fi
}

# Parse command line arguments
if [ $# -eq 0 ]; then
    # No arguments - run in current directory
    install_submodule "$(pwd)"
elif [ "$1" = "update" ]; then
    # Update command - update the script itself
    update_script
else
    # Path argument - run in specified directory
    install_submodule "$1"
fi
